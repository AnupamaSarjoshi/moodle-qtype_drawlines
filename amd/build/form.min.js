/**
 * This class provides the enhancements to the drawlines editing form.
 *
 * @module     qtype_drawlines/form
 * @copyright  2024 The Open University
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("qtype_drawlines/form",["jquery","core/dragdrop","qtype_drawlines/line"],(function($,dragDrop,Line){function LineManager(lineNo){this.lineNo=lineNo,this.svgEl=null,this.line=Line.make(this.getCoordinatesFromForm(this.lineNo),this.getLabel(),this.getLineType()),this.updateCoordinatesFromForm()}LineManager.prototype.displayInitialLine=function(){let defaultstartpoint,defaultendpoint,startCoords,endCoords,coords=this.getCoordinatesFromForm(this.lineNo),linespacing=0;""!==coords[0]&&""!==coords[1]||"choose"===this.getLineType()||(linespacing=0===this.lineNo?0:15*this.lineNo,defaultstartpoint=15*(this.lineNo+1)+linespacing,defaultendpoint=defaultstartpoint+15,startCoords=defaultstartpoint+","+defaultstartpoint+";8",endCoords=defaultendpoint+","+defaultendpoint+";8",drawlinesForm.setFormValue("zonestart",[this.lineNo],startCoords),drawlinesForm.setFormValue("zoneend",[this.lineNo],endCoords)),"choose"===this.getLineType()&&(drawlinesForm.setFormValue("zonestart",[this.lineNo],""),drawlinesForm.setFormValue("zoneend",[this.lineNo],""))},LineManager.prototype.updateCoordinatesFromForm=function(svg){var coordinates=this.getCoordinatesFromForm(this.lineNo);if(this.validateFormCoordinates(this.lineNo)&&this.line.parse(coordinates[0],coordinates[1],1)){if(this.line.getCoordinates()!==coordinates){var currentyActive=this.isActive();this.removeFromSvg(),svg&&(this.addToSvg(svg),currentyActive&&this.setActive())}else this.updateSvgEl();this.setCoordinatesInForm()}},LineManager.prototype.validateFormCoordinates=function(lineNo){var coords=this.getCoordinatesFromForm(lineNo),regexp=/^\d+,\d+;\d+$/;return regexp.test(coords[0])&&regexp.test(coords[1])},LineManager.prototype.setCoordinatesInForm=function(){var linecoords=this.line.getCoordinates();drawlinesForm.setFormValue("zonestart",[this.lineNo],linecoords[0]),drawlinesForm.setFormValue("zoneend",[this.lineNo],linecoords[1])},LineManager.prototype.getCoordinatesFromForm=function(lineNo){return[drawlinesForm.getFormValue("zonestart",[lineNo]),drawlinesForm.getFormValue("zoneend",[lineNo])]},LineManager.prototype.updateLabel=function(){var label=this.getLabel();this.line.labelstart===label[0]&&this.line.labelend===label[1]||(this.line.labelstart=label[0],this.line.labelend=label[1],this.updateSvgEl())},LineManager.prototype.getLineType=function(){return drawlinesForm.getFormValue("type",[this.lineNo])},LineManager.prototype.getLabel=function(){return[drawlinesForm.getFormValue("labelstart",[this.lineNo]),drawlinesForm.getFormValue("labelend",[this.lineNo])]},LineManager.prototype.updateSvgEl=function(){if(null!==this.svgEl&&this.validateFormCoordinates(this.lineNo)){this.line.updateSvg(this.svgEl);var handles=this.line.getHandlePositions();if(null!==handles){var i=0;for(i=0;i<handles.moveHandles.length;++i)this.svgEl.childNodes[5+i].setAttribute("cx",handles.moveHandles[i].x),this.svgEl.childNodes[5+i].setAttribute("cy",handles.moveHandles[i].y);for(i=0;i<handles.editHandles.length;++i)this.svgEl.childNodes[7+i].setAttribute("x",handles.editHandles[i].x-6),this.svgEl.childNodes[7+i].setAttribute("y",handles.editHandles[i].y-6)}}},LineManager.prototype.changeShape=function(svg){var newLineType=this.getLineType(),currentyActive=this.isActive();newLineType!==this.line.getType()&&(this.removeFromSvg(),"choose"!==newLineType&&(this.line=Line.getSimilar(newLineType,this.line),svg&&(this.addToSvg(svg),currentyActive&&this.setActive())))},LineManager.prototype.isActive=function(){return null!==this.svgEl&&this.svgEl.getAttribute("class").match(/\bactive\b/)},LineManager.prototype.setActive=function(){this.svgEl.setAttribute("class",this.svgEl.getAttribute("class")+" active")},LineManager.prototype.addToSvg=function(svg){if(null!==this.svgEl)throw new Error("this.svgEl already set");if(this.validateFormCoordinates(this.lineNo)&&(this.svgEl=this.line.makeSvg(svg),this.svgEl)){this.svgEl.setAttribute("class","dropzone"),this.svgEl.setAttribute("data-dropzone-no",this.lineNo);var handles=this.line.getHandlePositions();null!==handles&&(this.makeMoveHandle(0,handles.moveHandles[0],"handlestart move"),this.makeMoveHandle(1,handles.moveHandles[1],"handleend move"),this.makeEditHandle(0,handles.editHandles[0],"handlestart edit"),this.makeEditHandle(1,handles.editHandles[1],"handleend edit"))}},LineManager.prototype.makeMoveHandle=function(index,point,handleclass){var moveHandle=Line.createSvgElement(this.svgEl,"circle");moveHandle.setAttribute("cx",point.x),moveHandle.setAttribute("cy",point.y),moveHandle.setAttribute("r",7),moveHandle.setAttribute("class",handleclass),moveHandle.setAttribute("data-move-handle-no",index),moveHandle.setAttribute("tabindex",0)},LineManager.prototype.makeEditHandle=function(index,point,handleclass){var editHandle=Line.createSvgElement(this.svgEl,"rect");editHandle.setAttribute("x",point.x-6),editHandle.setAttribute("y",point.y-6),editHandle.setAttribute("width",11),editHandle.setAttribute("height",11),editHandle.setAttribute("class",handleclass),editHandle.setAttribute("data-edit-handle-no",index),editHandle.setAttribute("tabindex",0)},LineManager.prototype.makeDragProxy=function(x,y){var dragProxy=document.createElement("div");return dragProxy.style.position="absolute",dragProxy.style.top=y+"px",dragProxy.style.left=x+"px",dragProxy.style.width="1px",dragProxy.style.height="1px",document.body.appendChild(dragProxy),dragProxy},LineManager.prototype.handleMouseEvents=function(e,handleIndex,handleType){var info=dragDrop.prepare(e);if(info.start){var changingDropZone=this,lastX=parseInt(info.x),lastY=parseInt(info.y),dragProxy=this.makeDragProxy(info.x,info.y),bgImg=document.querySelector("fieldset#id_previewareaheader .dropbackground"),maxX=parseInt(bgImg.width),maxY=parseInt(bgImg.height);dragDrop.start(e,$(dragProxy),(function(pageX,pageY){switch(handleType){case"edit":changingDropZone.line.edit(handleIndex,parseInt(pageX)-lastX,parseInt(pageY)-lastY,maxX,maxY),changingDropZone.line.normalizeShape();break;case"move":changingDropZone.line.move(handleIndex,parseInt(pageX)-lastX,parseInt(pageY)-lastY,maxX,maxY);break;case"line":changingDropZone.line.moveDrags(parseInt(pageX)-lastX,parseInt(pageY)-lastY,maxX,maxY,"")}lastX=pageX,lastY=pageY,changingDropZone.updateSvgEl(),changingDropZone.setCoordinatesInForm()}),(function(){document.body.removeChild(dragProxy)}))}},LineManager.prototype.handleKeyPress=function(event,drag,handleIndex,handleType){var x=0,y=0;switch(event.code){case"ArrowLeft":case"KeyA":x=-1;break;case"ArrowRight":case"KeyD":x=1;break;case"ArrowDown":case"KeyS":y=1;break;case"ArrowUp":case"KeyW":y=-1;break;case"Space":case"Escape":break;default:return}event.preventDefault();var bgImg=document.querySelector("fieldset#id_previewareaheader .dropbackground"),maxX=bgImg.width,maxY=bgImg.height;"move"===handleType?this.line.move(handleIndex,parseInt(x),parseInt(y),parseInt(maxX),parseInt(maxY)):"edit"===handleType?(this.line.edit(handleIndex,parseInt(x),parseInt(y),parseInt(maxX),parseInt(maxY)),this.line.normalizeShape()):"line"===handleType&&this.line.moveDrags(parseInt(x),parseInt(y),parseInt(maxX),parseInt(maxY),""),this.updateSvgEl(),this.setCoordinatesInForm(),drag.focus()},LineManager.prototype.removeFromSvg=function(){null!==this.svgEl&&(this.svgEl.parentNode.removeChild(this.svgEl),this.svgEl=null)};const drawlinesForm={fp:null,noOfLines:null,dropZones:[],init:function(){drawlinesForm.noOfLines=drawlinesForm.getFormValue("numberoflines",[]),drawlinesForm.createShapes(),drawlinesForm.fp=drawlinesForm.filePickers(),drawlinesForm.setupEventHandlers(),drawlinesForm.waitForFilePickerToInitialise()},filePickers:function(){var draftItemIdsToName,nameToParentNode;void 0===draftItemIdsToName&&(draftItemIdsToName={},nameToParentNode={},document.querySelectorAll('form.mform[data-qtype="drawlines"] input.filepickerhidden').forEach((function(filepicker){draftItemIdsToName[filepicker.value]=filepicker.name,nameToParentNode[filepicker.name]=filepicker.parentNode})));return{file:function(name){var parentNode=nameToParentNode[name];if(parentNode){var fileAnchor=parentNode.querySelector("div.filepicker-filelist a");if(fileAnchor)return{href:fileAnchor.href,name:fileAnchor.innerHTML}}return{href:null,name:null}},name:function(draftitemid){return draftItemIdsToName[draftitemid]}}},loadPreviewImage:function(){document.getElementById("dlines-droparea")||drawlinesForm.setupPreviewArea();var img=document.querySelector("fieldset#id_previewareaheader .dropbackground");img&&(img.addEventListener("load",(function(){drawlinesForm.afterPreviewImageLoaded()}),{once:!0}),img.src=drawlinesForm.fp.file("bgimage").href)},setupPreviewArea:function(){var previewareaheader=document.querySelector("fieldset#id_previewareaheader");null!==drawlinesForm.fp.file("bgimage").href&&previewareaheader.insertAdjacentHTML("beforeend",'<div class="ddarea que drawlines">  <div id="dlines-droparea" class="droparea">    <img class="dropbackground" />    <div id="dlines-dropzone" class="dropzones"></div>  </div>  <div class="dragitems"></div></div>')},setupEventHandlers:function(){for(var lineSelector="fieldset#id_linexheader_0",lineNo=0;lineNo<drawlinesForm.noOfLines;lineNo++)lineSelector="fieldset#id_linexheader_"+lineNo,document.querySelector(lineSelector).addEventListener("change",(function(e){if(e.target.matches("input, select")){var ids=e.target.name.match(/^([a-z]*)\[(\d+)]$/);if(!e.target.name)return;var dropzoneNo=ids[2],inputType=ids[1],dropZone=drawlinesForm.dropZones[dropzoneNo];switch(inputType){case"zonestart":case"zoneend":dropZone.updateCoordinatesFromForm(drawlinesForm.getSvg());break;case"type":dropZone.displayInitialLine(),dropZone.updateCoordinatesFromForm(drawlinesForm.getSvg()),dropZone.changeShape(drawlinesForm.getSvg());break;case"labelstart":case"labelend":dropZone.updateLabel()}}}));var previewArea=document.querySelector("fieldset#id_previewareaheader");previewArea.addEventListener("click",(function(event){if(event.target.closest("g.dropzone")){var dropzoneElement=event.target.closest("g.dropzone");drawlinesForm.setElementActive(dropzoneElement)}else drawlinesForm.setElementActive(null)})),previewArea.addEventListener("keydown",(function(event){if(event.target.closest("g.dropzone")){var dropzoneElement=event.target.closest("g.dropzone");drawlinesForm.setElementActive(dropzoneElement)}})),previewArea.addEventListener("mousedown",drawlinesForm.handleEventLine),previewArea.addEventListener("touchstart",drawlinesForm.handleEventLine),previewArea.addEventListener("mousedown",drawlinesForm.handleEventMove),previewArea.addEventListener("touchstart",drawlinesForm.handleEventMove),previewArea.addEventListener("mousedown",drawlinesForm.handleEventEdit),previewArea.addEventListener("touchstart",drawlinesForm.handleEventEdit),previewArea.addEventListener("keydown",drawlinesForm.handleKeyPress),previewArea.addEventListener("keypress",drawlinesForm.handleKeyPress)},setElementActive:function(dropzoneElement){let svgElement,activeDropzones;if(null!==dropzoneElement){let dropzoneNo=dropzoneElement.dataset.dropzoneNo;drawlinesForm.dropZones[dropzoneNo].isActive()||(svgElement=drawlinesForm.getSvg(),activeDropzones=svgElement.querySelectorAll(".dropzone.active"),activeDropzones.forEach((function(activeDropzone){activeDropzone.classList.remove("active")})),drawlinesForm.dropZones[dropzoneNo].setActive())}else svgElement=drawlinesForm.getSvg(),activeDropzones=svgElement.querySelectorAll(".dropzone.active"),activeDropzones.forEach((function(activeDropzone){activeDropzone.classList.remove("active")}))},handleEventMove:function(event){var dropzoneNo,handleIndex;event.target.closest(".dropzone .handlestart.move")?(dropzoneNo=event.target.closest("g").dataset.dropzoneNo,handleIndex="startcircle",drawlinesForm.dropZones[dropzoneNo].handleMouseEvents(event,handleIndex,"move")):event.target.closest(".dropzone .handleend.move")&&(dropzoneNo=event.target.closest("g").dataset.dropzoneNo,handleIndex="endcircle",drawlinesForm.dropZones[dropzoneNo].handleMouseEvents(event,handleIndex,"move"))},handleEventEdit:function(event){var dropzoneNo,handleIndex;(event.target.closest(".dropzone .handlestart.edit")||event.target.closest(".dropzone .handleend.edit"))&&(dropzoneNo=event.target.closest("g").dataset.dropzoneNo,handleIndex=event.target.getAttribute("data-edit-handle-no"),drawlinesForm.dropZones[dropzoneNo].handleMouseEvents(event,handleIndex,"edit"))},handleEventLine:function(event){var dropzoneNo;event.target.closest("g.dropzone.active")&&(dropzoneNo=event.target.closest("g.active").dataset.dropzoneNo,drawlinesForm.dropZones[dropzoneNo].handleMouseEvents(event,"","line"))},handleKeyPress:function(e){var dropzoneNo,handleIndex,drag;event.target.closest(".dropzone.active .handlestart.move")?(dropzoneNo=event.target.closest("g").dataset.dropzoneNo,handleIndex="startcircle",drag=e.target.closest(".dropzone.active .handlestart.move"),drawlinesForm.dropZones[dropzoneNo].handleKeyPress(event,drag,handleIndex,"move")):event.target.closest(".dropzone.active .handleend.move")?(dropzoneNo=event.target.closest("g").dataset.dropzoneNo,handleIndex="endcircle",drag=e.target.closest(".dropzone.active .handleend.move"),drawlinesForm.dropZones[dropzoneNo].handleKeyPress(event,drag,handleIndex,"move")):event.target.closest(".dropzone.active .handlestart.edit")?(dropzoneNo=event.target.closest("g").dataset.dropzoneNo,handleIndex=event.target.getAttribute("data-edit-handle-no"),drag=e.target.closest(".dropzone.active .handlestart.edit"),drawlinesForm.dropZones[dropzoneNo].handleKeyPress(event,drag,handleIndex,"edit")):event.target.closest(".dropzone.active .handleend.edit")?(dropzoneNo=event.target.closest("g").dataset.dropzoneNo,handleIndex=event.target.getAttribute("data-edit-handle-no"),drag=e.target.closest(".dropzone.active .handleend.edit"),drawlinesForm.dropZones[dropzoneNo].handleKeyPress(event,drag,handleIndex,"edit")):e.target.closest("g.dropzone")&&(dropzoneNo=event.target.closest(".dropzone").dataset.dropzoneNo,drag=e.target.closest("g.dropzone.active"),drawlinesForm.dropZones[dropzoneNo].handleKeyPress(event,drag,"","line"))},waitForFilePickerToInitialise:function(){document.querySelectorAll('form.mform[data-qtype="drawlines"]').forEach((function(form){form.addEventListener("change",drawlinesForm.loadPreviewImage)})),document.getElementById("dlines-droparea")||drawlinesForm.setupPreviewArea(),drawlinesForm.loadPreviewImage()},afterPreviewImageLoaded:function(){var bgImg=document.querySelector("fieldset#id_previewareaheader .dropbackground");document.getElementById("dlines-dropzone").style.position="relative",document.getElementById("dlines-dropzone").style.top=-1*(bgImg.height+1)+"px",document.getElementById("dlines-droparea").style.height=bgImg.height+20+"px",drawlinesForm.updateSvgDisplay()},updateSvgDisplay:function(){var bgImg=document.querySelector("fieldset#id_previewareaheader .dropbackground");if(drawlinesForm.getSvg())for(var lineNo=0;lineNo<drawlinesForm.noOfLines;lineNo++)drawlinesForm.dropZones[lineNo].updateSvgEl();else{document.getElementById("dlines-dropzone").innerHTML='<svg xmlns="http://www.w3.org/2000/svg" class="dropzones" width="'+bgImg.width+'" height="'+bgImg.height+'"></svg>';for(var lines=0;lines<drawlinesForm.noOfLines;lines++)drawlinesForm.dropZones[lines].addToSvg(drawlinesForm.getSvg())}},getSvg:function(){var svg=document.querySelector("fieldset#id_previewareaheader svg");return null===svg?null:svg},toNameWithIndex:function(name,indexes){for(var indexString=name,i=0;i<indexes.length;i++)indexString=indexString+"["+indexes[i]+"]";return indexString},getEl:function(name,indexes){return document.querySelector('form.mform[data-qtype="drawlines"]').elements[this.toNameWithIndex(name,indexes)]},getFormValue:function(name,indexes){return this.getEl(name,indexes).value},setFormValue:function(name,indexes,value){var el=this.getEl(name,indexes);"checkbox"===el.type?el.checked=value:el.value=value},createShapes:function(){for(var lineNo=0;lineNo<drawlinesForm.noOfLines;lineNo++)drawlinesForm.dropZones[lineNo]=new LineManager(lineNo)}};return{init:drawlinesForm.init}}));

//# sourceMappingURL=form.min.js.map