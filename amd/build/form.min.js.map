{"version":3,"file":"form.min.js","sources":["../src/form.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * JavaScript to allow dragging options to slots (using mouse down or touch) or tab through slots using keyboard.\n *\n * @module     qtype_drawlines/form\n * @copyright  2024 The Open University\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery', 'core/dragdrop', 'qtype_drawlines/Line'], function($, dragDrop, Line,) {\n    /**\n     * Create the manager object that deals with keeping everything synchronised for one line.\n     *\n     * @param {int} lineNo the index of this line in the form. 0, 1, ....\n     * @constructor\n     */\n    function LineManager(lineNo) {\n        this.lineNo = lineNo;\n        this.svgEl = null;\n        this.line = Line.make(this.getCoordinates(), this.getLabel(), this.getLineType());\n        this.updateCoordinatesFromForm();\n    }\n    /**\n     * Update the coordinates from a particular string.\n     */\n    LineManager.prototype.updateCoordinatesFromForm = function() {\n        var coordinates = this.getCoordinates();\n        if (this.line.getCoordinates() === coordinates) {\n            return;\n        }\n        // We don't need to scale the shape for editing form.\n        if (!this.line.parse(coordinates[0], coordinates[1], 1)) {\n            // Invalid coordinates. Don't update the preview.\n            return;\n        }\n\n        this.updateSvgEl();\n        // Update the rounded coordinates if needed.\n        this.setCoordinatesInForm();\n    };\n\n    /**\n     * Update the labels.\n     */\n    LineManager.prototype.updateLabel = function() {\n        var label = this.getLabel();\n        if (this.line.labelstart !== label[0] || this.line.labelend !== label[1]) {\n            this.line.labelstart = label[0];\n            this.line.labelend = label[1];\n            this.updateSvgEl();\n        }\n    };\n\n    /**\n     * Set the coordinates in the form to match the current shape.\n     */\n    LineManager.prototype.setCoordinatesInForm = function() {\n        var linecoords = this.line.getCoordinates();\n        drawlinesForm.setFormValue('zonestart', [this.lineNo], linecoords[0]);\n        drawlinesForm.setFormValue('zoneend', [this.lineNo], linecoords[1]);\n    };\n\n    /**\n     * Returns the coordinates for the line from the text input in the form.\n     * @returns {Array} the coordinates.\n     */\n    LineManager.prototype.getCoordinates = function() {\n        var zonestart = drawlinesForm.getFormValue('zonestart', [this.lineNo]);\n        var zoneend = drawlinesForm.getFormValue('zoneend', [this.lineNo]);\n        return [zonestart, zoneend];\n    };\n\n    /**\n     * Returns the selected type of line in the form.\n     * @returns {String} 'linesegment','linesinglearrow', 'linedoublearrows', 'lineinfinite'.\n     */\n    LineManager.prototype.getLineType = function() {\n        return drawlinesForm.getFormValue('type', [this.lineNo]);\n    };\n\n    /**\n     * Returns the line labels in the form.\n     * @returns {Array} line labels text.\n     */\n    LineManager.prototype.getLabel = function() {\n        return [\n            drawlinesForm.getFormValue('labelstart', [this.lineNo]),\n            drawlinesForm.getFormValue('labelend', [this.lineNo])\n        ];\n    };\n\n    /**\n     * Update the shape of this drop zone (but not type) in an SVG image.\n     */\n    LineManager.prototype.updateSvgEl = function() {\n        if (this.svgEl === null) {\n            return;\n        }\n        this.line.updateSvg(this.svgEl);\n\n        // Adjust handles.\n        var handles = this.line.getHandlePositions();\n        if (handles === null) {\n            return;\n        }\n\n        // Move handle.\n        // The shape + its labels are the first few children of svgEl.\n        // Then come the move handle followed by the edit handles.\n        var i = 0;\n        for (i = 0; i < handles.moveHandles.length; ++i) {\n            this.svgEl.childNodes[5 + i].setAttribute('cx', handles.moveHandles[i].x);\n            this.svgEl.childNodes[5 + i].setAttribute('cy', handles.moveHandles[i].y);\n        }\n\n        // Edit handles.\n        for (i = 0; i < handles.editHandles.length; ++i) {\n            this.svgEl.childNodes[7 + i].setAttribute('x', handles.editHandles[i].x - 6);\n            this.svgEl.childNodes[7 + i].setAttribute('y', handles.editHandles[i].y - 6);\n        }\n    };\n\n    /**\n     * Handle if the line type has changed.\n     *\n     * @param {SVGElement} [svg] an SVG element to add this new shape to.\n     */\n    LineManager.prototype.changeShape = function(svg) {\n        var newLineType = this.getLineType(),\n            currentyActive = this.isActive();\n        if (newLineType === this.line.getType()) {\n            return;\n        }\n\n        // It has really changed.\n        this.removeFromSvg();\n        this.line = Line.getSimilar(newLineType, this.line);\n        if (svg) {\n            this.addToSvg(svg);\n            if (currentyActive) {\n                this.setActive();\n            }\n        }\n    };\n\n    /**\n     * Find out if this line element is currently being edited.\n     *\n     * @return {boolean} true if it is.\n     */\n    LineManager.prototype.isActive = function() {\n        return this.svgEl !== null && this.svgEl.getAttribute('class').match(/\\bactive\\b/);\n    };\n\n    /**\n     * Set this line element as being edited.\n     */\n    LineManager.prototype.setActive = function() {\n        // Move this one to last, so that it is always on top.\n        // (Otherwise the handles may not be able to receive events.)\n        var parent = this.svgEl.parentNode;\n        parent.removeChild(this.svgEl);\n        parent.appendChild(this.svgEl);\n        this.svgEl.setAttribute('class', this.svgEl.getAttribute('class') + ' active');\n    };\n\n    /**\n     * Add this line to an SVG graphic.\n     *\n     * @param {SVGElement} svg the SVG image to which to add this drop zone.\n     */\n    LineManager.prototype.addToSvg = function(svg) {\n        if (this.svgEl !== null) {\n            throw new Error('this.svgEl already set');\n        }\n        this.svgEl = this.line.makeSvg(svg);\n        if (!this.svgEl) {\n            return;\n        }\n        this.svgEl.setAttribute('class', 'dropzone');\n        this.svgEl.setAttribute('data-dropzone-no', this.lineNo);\n\n        // Add handles.\n        var handles = this.line.getHandlePositions();\n        if (handles === null) {\n            return;\n        }\n\n        // Add handles to the line points.\n        this.makeMoveHandle(0, handles.moveHandles[0], \"handlestart move\");\n        this.makeMoveHandle(1, handles.moveHandles[1], \"handleend move\");\n\n        // Add edithandles to the circles to set the start and end radius.\n        this.makeEditHandle(0, handles.editHandles[0], \"handlestart edit\");\n        this.makeEditHandle(1, handles.editHandles[1], \"handleend edit\");\n    };\n\n    /**\n     * Add a new move handle.\n     *\n     * @param {int} index the handle index.\n     * @param {Point} point the point at which to add the handle.\n     * @param {String} handleclass the class attribute to add to the handle.\n     */\n    LineManager.prototype.makeMoveHandle = function(index, point, handleclass) {\n        var moveHandle = Line.createSvgElement(this.svgEl, 'circle');\n        moveHandle.setAttribute('cx', point.x);\n        moveHandle.setAttribute('cy', point.y);\n        moveHandle.setAttribute('r', 7);\n        moveHandle.setAttribute('class', handleclass);\n        moveHandle.setAttribute('data-move-handle-no', index);\n    };\n\n    /**\n     * Add a new edit handle.\n     *\n     * @param {int} index the handle index.\n     * @param {Point} point the point at which to add the handle.\n     * @param {String} handleclass the class attribute to add to the handle.\n     */\n    LineManager.prototype.makeEditHandle = function(index, point, handleclass) {\n        var editHandle = Line.createSvgElement(this.svgEl, 'rect');\n        editHandle.setAttribute('x', point.x - 6);\n        editHandle.setAttribute('y', point.y - 6);\n        editHandle.setAttribute('width', 11);\n        editHandle.setAttribute('height', 11);\n        editHandle.setAttribute('class', handleclass);\n        editHandle.setAttribute('data-edit-handle-no', index);\n    };\n\n    /**\n     * Start responding to dragging the move handle.\n     * @param {Event} e Event object\n     * @param {String} handleIndex\n     */\n    LineManager.prototype.handleMove = function(e, handleIndex) {\n        var info = dragDrop.prepare(e);\n        if (!info.start) {\n            return;\n        }\n\n        var movingDropZone = this,\n            lastX = info.x,\n            lastY = info.y,\n            dragProxy = this.makeDragProxy(info.x, info.y),\n            bgImg = document.querySelector('fieldset#id_previewareaheader .dropbackground'),\n            maxX = bgImg.width,\n            maxY = bgImg.height;\n\n        dragDrop.start(e, $(dragProxy), function(pageX, pageY) {\n            movingDropZone.line.move(handleIndex, pageX - lastX, pageY - lastY, maxX, maxY);\n            lastX = pageX;\n            lastY = pageY;\n            movingDropZone.updateSvgEl();\n            movingDropZone.setCoordinatesInForm();\n        }, function() {\n            document.body.removeChild(dragProxy);\n        });\n    };\n\n    /**\n     * Make an invisible drag proxy.\n     *\n     * @param {int} x x position .\n     * @param {int} y y position.\n     * @returns {HTMLElement} the drag proxy.\n     */\n    LineManager.prototype.makeDragProxy = function(x, y) {\n        var dragProxy = document.createElement('div');\n        dragProxy.style.position = 'absolute';\n        dragProxy.style.top = y + 'px';\n        dragProxy.style.left = x + 'px';\n        dragProxy.style.width = '1px';\n        dragProxy.style.height = '1px';\n        document.body.appendChild(dragProxy);\n        return dragProxy;\n    };\n\n    /**\n     * Start responding to dragging the move handle.\n     * @param {Event} e Event object\n     * @param {String} handleIndex\n     */\n    LineManager.prototype.handleEdit = function(e, handleIndex) {\n        var info = dragDrop.prepare(e);\n        if (!info.start) {\n            return;\n        }\n\n        var changingDropZone = this,\n            lastX = info.x,\n            lastY = info.y,\n            dragProxy = this.makeDragProxy(info.x, info.y),\n            bgImg = document.querySelector('fieldset#id_previewareaheader .dropbackground'),\n            maxX = bgImg.width,\n            maxY = bgImg.height;\n\n        dragDrop.start(e, $(dragProxy), function(pageX, pageY) {\n            changingDropZone.line.edit(handleIndex, pageX - lastX, pageY - lastY, maxX, maxY);\n            lastX = pageX;\n            lastY = pageY;\n            changingDropZone.updateSvgEl();\n            changingDropZone.setCoordinatesInForm();\n        }, function() {\n            document.body.removeChild(dragProxy);\n            changingDropZone.line.normalizeShape();\n            changingDropZone.updateSvgEl();\n            changingDropZone.setCoordinatesInForm();\n        });\n    };\n\n    /**\n     * Remove this line from an SVG image.\n     */\n    LineManager.prototype.removeFromSvg = function() {\n        if (this.svgEl !== null) {\n            this.svgEl.parentNode.removeChild(this.svgEl);\n            this.svgEl = null;\n        }\n    };\n\n    /**\n     * Singleton object for managing all the parts of the form.\n     */\n    const drawlinesForm = {\n\n        /**\n         * @var {object} for interacting with the file pickers.\n         */\n        fp: null, // Object containing functions associated with the file picker.\n\n        /**\n         * @var {int} the number of lines on the form.\n         */\n        noOfLines: null,\n\n        /**\n         * @var {LineManager[]} the lines in the preview, indexed by line number.\n         */\n        dropZones: [],\n\n        /**\n         * Init method.\n         */\n        init: function() {\n            drawlinesForm.noOfLines = drawlinesForm.getFormValue('numberoflines', []);\n            drawlinesForm.createShapes();\n            drawlinesForm.fp = drawlinesForm.filePickers();\n            drawlinesForm.setupEventHandlers();\n            drawlinesForm.waitForFilePickerToInitialise();\n        },\n\n        /**\n         * Utility to get the file name and url from the filepicker.\n         * @returns {Object} object containing functions {file, name}\n         */\n        filePickers: function() {\n            var draftItemIdsToName;\n            var nameToParentNode;\n            if (draftItemIdsToName === undefined) {\n                draftItemIdsToName = {};\n                nameToParentNode = {};\n                var fp = document.querySelectorAll('form.mform[data-qtype=\"drawlines\"] input.filepickerhidden');\n                fp.forEach(function(filepicker) {\n                    draftItemIdsToName[filepicker.value] = filepicker.name;\n                    nameToParentNode[filepicker.name] = filepicker.parentNode;\n                });\n            }\n\n            return {\n                file: function(name) {\n                    var parentNode = nameToParentNode[name];\n                    if (parentNode) {\n                        var fileAnchor = parentNode.querySelector('div.filepicker-filelist a');\n                        if (fileAnchor) {\n                            return {href: fileAnchor.href, name: fileAnchor.innerHTML};\n                        }\n                    }\n                    return {href: null, name: null};\n                },\n\n                name: function(draftitemid) {\n                    return draftItemIdsToName[draftitemid];\n                }\n            };\n        },\n\n        /**\n         * Loads the preview background image.\n         */\n        loadPreviewImage: function() {\n            var img = document.querySelector('fieldset#id_previewareaheader .dropbackground');\n            if (img) {\n                img.addEventListener('load', function() {\n                    drawlinesForm.afterPreviewImageLoaded();\n                }, {once: true});\n                img.src = drawlinesForm.fp.file('bgimage').href;\n            }\n        },\n\n        /**\n         * Add html for the preview area.\n         */\n        setupPreviewArea: function() {\n            var previewareaheader = document.querySelector('fieldset#id_previewareaheader');\n            if (drawlinesForm.fp.file('bgimage').href !== null) {\n                previewareaheader.insertAdjacentHTML('beforeend',\n                    '<div class=\"ddarea que drawlines\">' +\n                    '  <div id=\"dlines-droparea\" class=\"droparea\">' +\n                    '    <img class=\"dropbackground\" />' +\n                    '    <div id=\"dlines-dropzone\" class=\"dropzones\"></div>' +\n                    '  </div>' +\n                    '  <div class=\"dragitems\"></div>' +\n                    '</div>');\n            }\n        },\n\n        /**\n         * Events linked to form actions.\n         */\n        setupEventHandlers: function() {\n            // Changes to Drop zones section: shape, coordinates and marker.\n            var lineSelector = 'fieldset#id_linexheader_' + '0';\n\n            for (var lineNo = 0; lineNo < drawlinesForm.noOfLines; lineNo++) {\n                lineSelector = 'fieldset#id_linexheader_' + lineNo;\n                document.querySelector(lineSelector).addEventListener('input', function(e) {\n                    if (e.target.matches('input, select')) {\n                        var ids = e.target.name.match(/^([a-z]*)\\[(\\d+)]$/);\n                        var id = e.target.name;\n                        if (!id) {\n                            return;\n                        }\n                        var dropzoneNo = ids[2],\n                            inputType = ids[1],\n                            dropZone = drawlinesForm.dropZones[dropzoneNo];\n\n                        switch (inputType) {\n                            case 'zonestart':\n                            case 'zoneend':\n                                dropZone.updateCoordinatesFromForm(drawlinesForm.getSvg());\n                                break;\n\n                            case 'type':\n                                dropZone.updateCoordinatesFromForm(drawlinesForm.getSvg());\n                                dropZone.changeShape(drawlinesForm.getSvg());\n                                break;\n\n                            case 'labelstart':\n                            case 'labelend':\n                                dropZone.updateLabel();\n                                break;\n                        }\n                    }\n                });\n            }\n\n            // Click to toggle graphical editing.\n            var previewArea = document.querySelector('fieldset#id_previewareaheader');\n            previewArea.addEventListener('click', function(event) {\n                if (event.target.closest('g.dropzone')) {\n                    var dropzoneElement = event.target.closest('g.dropzone');\n\n                    var dropzoneNo = dropzoneElement.dataset.dropzoneNo;\n                    var currentlyActive = drawlinesForm.dropZones[dropzoneNo].isActive();\n\n                    // Find all active dropzones and remove the 'active' class\n                    var svgElement = drawlinesForm.getSvg();\n                    var activeDropzones = svgElement.querySelectorAll('.dropzone.active');\n                    activeDropzones.forEach(function(activeDropzone) {\n                        activeDropzone.classList.remove('active');\n                    });\n\n                    // If the dropzone was not active, set it as active\n                    if (!currentlyActive) {\n                        drawlinesForm.dropZones[dropzoneNo].setActive();\n                    }\n                }\n            });\n\n            // Add event listeners to the 'previewArea'.\n            previewArea.addEventListener('mousedown', drawlinesForm.handleEventMove);\n            previewArea.addEventListener('touchstart', drawlinesForm.handleEventMove);\n            previewArea.addEventListener('mousedown', drawlinesForm.handleEventEdit);\n            previewArea.addEventListener('touchstart', drawlinesForm.handleEventEdit);\n        },\n\n        handleEventMove: function(event) {\n            var dropzoneElement, dropzoneNo, handleIndex;\n            if (event.target.closest('.dropzone .handlestart.move')) {\n                dropzoneElement = event.target.closest('g');\n                dropzoneNo = dropzoneElement.dataset.dropzoneNo;\n                handleIndex = event.target.getAttribute('data-move-handle-no');\n                drawlinesForm.dropZones[dropzoneNo].handleMove(event, handleIndex);\n            } else if (event.target.closest('.dropzone .handleend.move')) {\n                dropzoneElement = event.target.closest('g');\n                dropzoneNo = dropzoneElement.dataset.dropzoneNo;\n                handleIndex = event.target.getAttribute('data-move-handle-no');\n                drawlinesForm.dropZones[dropzoneNo].handleMove(event, handleIndex);\n            }\n        },\n\n        handleEventEdit: function(event) {\n            var dropzoneElement, dropzoneNo, handleIndex;\n            if (event.target.closest('.dropzone .handlestart.edit')) {\n                dropzoneElement = event.target.closest('g');\n                dropzoneNo = dropzoneElement.dataset.dropzoneNo;\n                handleIndex = event.target.getAttribute('data-edit-handle-no');\n                drawlinesForm.dropZones[dropzoneNo].handleEdit(event, handleIndex);\n            } else if (event.target.closest('.dropzone .handleend.edit')) {\n                dropzoneElement = event.target.closest('g');\n                dropzoneNo = dropzoneElement.dataset.dropzoneNo;\n                handleIndex = event.target.getAttribute('data-edit-handle-no');\n                drawlinesForm.dropZones[dropzoneNo].handleEdit(event, handleIndex);\n            }\n        },\n\n        /**\n         * Waits for the file-pickers to be sufficiently ready before initialising the preview.\n         */\n        waitForFilePickerToInitialise: function() {\n            // Add event listener for change events on the file picker elements\n            document.querySelectorAll('form.mform[data-qtype=\"drawlines\"]').forEach(function(form) {\n                form.addEventListener('change', drawlinesForm.loadPreviewImage);\n            });\n\n            // Check if the element with id 'id_droparea' exists\n            if (document.getElementById('dlines-droparea')) {\n                drawlinesForm.loadPreviewImage();\n            } else {\n                // Setup preview area when the background image is uploaded the first time\n                drawlinesForm.setupPreviewArea();\n                drawlinesForm.loadPreviewImage();\n            }\n        },\n\n        /**\n         * Functions to run after background image loaded.\n         */\n        afterPreviewImageLoaded: function() {\n            var bgImg = document.querySelector('fieldset#id_previewareaheader .dropbackground');\n            // Place the dropzone area over the background image (adding one to account for the border).\n            document.getElementById('dlines-dropzone').style.position = 'relative';\n            document.getElementById('dlines-dropzone').style.top = (bgImg.height + 1) * -1 + \"px\";\n            document.getElementById('dlines-droparea').style.height = bgImg.height + 20 + \"px\";\n            drawlinesForm.updateSvgDisplay();\n        },\n\n        /**\n         * Draws or re-draws all dropzones in the preview area based on form data.\n         * Call this function when there is a change in the form data.\n         */\n        updateSvgDisplay: function() {\n            var bgImg = document.querySelector('fieldset#id_previewareaheader .dropbackground');\n\n            if (drawlinesForm.getSvg()) {\n                // Already exists, just need to be updated.\n                for (var lineNo = 0; lineNo < drawlinesForm.noOfLines; lineNo++) {\n                    drawlinesForm.dropZones[lineNo].updateSvgEl();\n                }\n\n            } else {\n                // Create.\n                document.getElementById('dlines-dropzone').innerHTML =\n                    '<svg xmlns=\"http://www.w3.org/2000/svg\" class=\"dropzones\" ' +\n                    'width=\"' + bgImg.width + '\" ' +\n                    'height=\"' + bgImg.height + '\">' +\n                    '</svg>';\n                for (var lines = 0; lines < drawlinesForm.noOfLines; lines++) {\n                    drawlinesForm.dropZones[lines].addToSvg(drawlinesForm.getSvg());\n                }\n            }\n        },\n\n        /**\n         * Get the SVG element, if there is one, otherwise return null.\n         *\n         * @returns {SVGElement|null} the SVG element or null.\n         */\n        getSvg: function() {\n            var svg = document.querySelector('fieldset#id_previewareaheader svg');\n            if (svg === null) {\n                return null;\n            } else {\n                return svg;\n            }\n        },\n\n        toNameWithIndex: function(name, indexes) {\n            var indexString = name;\n            for (var i = 0; i < indexes.length; i++) {\n                indexString = indexString + '[' + indexes[i] + ']';\n            }\n            return indexString;\n        },\n\n        getEl: function(name, indexes) {\n            var form = document.querySelector('form.mform[data-qtype=\"drawlines\"]');\n            return form.elements[this.toNameWithIndex(name, indexes)];\n        },\n\n        /**\n         * Helper to get the value of a form elements with name like \"zonestart[0]\".\n         *\n         * @param {String} name the base name, e.g. 'zonestart'.\n         * @param {String[]} indexes the indexes, e.g. ['0'].\n         * @return {String} the value of that field.\n         */\n        getFormValue: function(name, indexes) {\n            var el = this.getEl(name, indexes);\n            return el.value;\n        },\n\n        /**\n         * Helper to get the value of a form elements with name like \"zonestart[0]\".\n         *\n         * @param {String} name the base name, e.g. 'zonestart'.\n         * @param {String[]} indexes the indexes, e.g. ['0'].\n         * @param {String} value the value to set.\n         */\n        setFormValue: function(name, indexes, value) {\n            var el = this.getEl(name, indexes);\n            if (el.type === 'checkbox') {\n                el.checked = value;\n            } else {\n                el.value = value;\n            }\n        },\n\n        /**\n         * Create the shape representation of each dropZone.\n         */\n        createShapes: function() {\n            for (var lineNo = 0; lineNo < drawlinesForm.noOfLines; lineNo++) {\n                drawlinesForm.dropZones[lineNo] = new LineManager(lineNo);\n            }\n        },\n\n    };\n\n    /**\n     * @alias module:qtype_ddmarker/form\n     */\n    return {\n        /**\n         * Initialise the form javascript features.\n         * @param {Object} maxBgimageSize object with two properties: width and height.\n         */\n        init: drawlinesForm.init\n    };\n});"],"names":["define","$","dragDrop","Line","LineManager","lineNo","svgEl","line","make","this","getCoordinates","getLabel","getLineType","updateCoordinatesFromForm","prototype","coordinates","parse","updateSvgEl","setCoordinatesInForm","updateLabel","label","labelstart","labelend","linecoords","drawlinesForm","setFormValue","getFormValue","updateSvg","handles","getHandlePositions","i","moveHandles","length","childNodes","setAttribute","x","y","editHandles","changeShape","svg","newLineType","currentyActive","isActive","getType","removeFromSvg","getSimilar","addToSvg","setActive","getAttribute","match","parent","parentNode","removeChild","appendChild","Error","makeSvg","makeMoveHandle","makeEditHandle","index","point","handleclass","moveHandle","createSvgElement","editHandle","handleMove","e","handleIndex","info","prepare","start","movingDropZone","lastX","lastY","dragProxy","makeDragProxy","bgImg","document","querySelector","maxX","width","maxY","height","pageX","pageY","move","body","createElement","style","position","top","left","handleEdit","changingDropZone","edit","normalizeShape","fp","noOfLines","dropZones","init","createShapes","filePickers","setupEventHandlers","waitForFilePickerToInitialise","draftItemIdsToName","nameToParentNode","undefined","querySelectorAll","forEach","filepicker","value","name","file","fileAnchor","href","innerHTML","draftitemid","loadPreviewImage","img","addEventListener","afterPreviewImageLoaded","once","src","setupPreviewArea","previewareaheader","insertAdjacentHTML","lineSelector","target","matches","ids","dropzoneNo","inputType","dropZone","getSvg","previewArea","event","closest","dataset","currentlyActive","activeDropzone","classList","remove","handleEventMove","handleEventEdit","form","getElementById","updateSvgDisplay","lines","toNameWithIndex","indexes","indexString","getEl","elements","el","type","checked"],"mappings":"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"}