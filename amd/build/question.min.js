/**
 * JavaScript to allow dragging options to slots (using mouse down or touch) or tab through slots using keyboard.
 *
 * @module     qtype_drawlines/question
 * @copyright  2024 The Open University
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("qtype_drawlines/question",["jquery","core/dragdrop","qtype_drawlines/Line","core/key_codes","core_form/changechecker"],(function($,dragDrop,Lines){function DrawlinesQuestion(containerId,readOnly,visibleDropZones,questionLines){var thisQ=this;this.containerId=containerId,this.visibleDropZones=visibleDropZones,this.questionLines=questionLines,this.lineSVGs=[],this.lines=[],this.isPrinting=!1,this.questionAnswer={},this.svgEl=null,readOnly&&this.getRoot().addClass("qtype_drawlines-readonly"),thisQ.allImagesLoaded=!1,thisQ.getNotYetLoadedImages().one("load",(function(){thisQ.waitForAllImagesToBeLoaded()})),thisQ.waitForAllImagesToBeLoaded()}DrawlinesQuestion.prototype.updateCoordinates=function(){for(var line=0;line<this.lineSVGs.length;line++){var coordinates=this.getCoordinates(this.lineSVGs[line]);if(!this.lines[line].parse(coordinates[0],coordinates[1],1))return;this.updateSvgEl(line)}},DrawlinesQuestion.prototype.parseCoordinates=function(coordinates,lineType){var bits=coordinates.split(" ");if("lineinfinite"===lineType&&2!==bits.length&&(bits=bits.slice(1,-1)),2!==bits.length)throw new Error(coordinates+" is not a valid point");return bits},DrawlinesQuestion.prototype.drawSVGLines=function(questionLines){var height,startcoordinates,endcoordinates,draginitialcoords,bgImage=document.querySelector("img.dropbackground");document.querySelector(".draghomes").innerHTML='<svg xmlns="http://www.w3.org/2000/svg" class="dragshome" id= "que-dlines-svg-dragshome" width="'+bgImage.width+'" height="'+50*questionLines.length+'"></svg>';var draghomeSvg=document.getElementById("que-dlines-svg-dragshome"),dropzoneSvg=document.getElementById("que-dlines-svg");for(let line=0;line<questionLines.length;line++)if(startcoordinates="50,"+(height=25+50*line)+";10",endcoordinates="200,"+height+";10",void 0!==(draginitialcoords=this.visibleDropZones["c"+line])&&""!==draginitialcoords){var coords=this.parseCoordinates(draginitialcoords,questionLines[line].type);startcoordinates=coords[0]+";10",endcoordinates=coords[1]+";10",this.lines[line]=Lines.make([startcoordinates,endcoordinates],[questionLines[line].labelstart,questionLines[line].labelend],questionLines[line].type),this.addToSvg(line,dropzoneSvg)}else this.lines[line]=Lines.make([startcoordinates,endcoordinates],[questionLines[line].labelstart,questionLines[line].labelend],questionLines[line].type),this.addToSvg(line,draghomeSvg)},DrawlinesQuestion.prototype.drawDropzone=function(){var bgImage=document.querySelector("img.dropbackground"),svg=document.querySelector("svg.dropzones");(document.getElementById("que-dlines-dropzone").style.position="relative",document.getElementById("que-dlines-dropzone").style.top=-1*(bgImage.height+1)+"px",document.getElementById("que-dlines-dropzone").style.height=bgImage.height+"px",document.getElementById("que-dlines-droparea").style.height=bgImage.height+"px",svg)||(document.querySelector("#que-dlines-dropzone").innerHTML='<svg xmlns="http://www.w3.org/2000/svg" id= "que-dlines-svg" class= "dropzones" width="'+bgImage.width+'" height="'+bgImage.height+'" ></svg>');this.drawSVGLines(this.questionLines)},DrawlinesQuestion.prototype.getRoot=function(){return $(document.getElementById(this.containerId))},DrawlinesQuestion.prototype.bgImage=function(){return this.getRoot().find("img.dropbackground")},DrawlinesQuestion.prototype.getCoordinates=function(svgEl){return[svgEl.childNodes[1].getAttribute("cx")+","+svgEl.childNodes[1].getAttribute("cy")+";"+svgEl.childNodes[1].getAttribute("r"),svgEl.childNodes[2].getAttribute("cx")+","+svgEl.childNodes[2].getAttribute("cy")+";"+svgEl.childNodes[2].getAttribute("r")]},DrawlinesQuestion.prototype.bgRatio=function(){var bgImg=this.bgImage(),bgImgNaturalWidth=bgImg.get(0).naturalWidth;return bgImg.width()/bgImgNaturalWidth},DrawlinesQuestion.prototype.addToSvg=function(lineNumber,svg){this.lineSVGs[lineNumber]=this.lines[lineNumber].makeSvg(svg),this.lineSVGs[lineNumber]&&(this.lineSVGs[lineNumber].setAttribute("data-dropzone-no",lineNumber),"dropzones"===svg.getAttribute("class")?this.lineSVGs[lineNumber].setAttribute("class","dropzone choice"+lineNumber+" placed"):this.lineSVGs[lineNumber].setAttribute("class","dropzone choice"+lineNumber+" inactive"))},DrawlinesQuestion.prototype.updateSvgEl=function(dropzoneNo){this.lines[dropzoneNo].updateSvg(this.lineSVGs[dropzoneNo])},DrawlinesQuestion.prototype.handleCircleMove=function(e,whichHandle,dropzoneNo){var info=dragDrop.prepare(e);if(info.start){var movingDropZone=this,lastX=info.x,lastY=info.y,dragProxy=this.makeDragProxy(info.x,info.y),svg=document.querySelector("svg.dropzones"),maxX=svg.width.baseVal.value,maxY=svg.height.baseVal.value;dragDrop.start(e,$(dragProxy),(function(pageX,pageY){movingDropZone.lines[dropzoneNo].move(whichHandle,parseInt(pageX)-parseInt(lastX),parseInt(pageY)-parseInt(lastY),parseInt(maxX),parseInt(maxY)),lastX=pageX,lastY=pageY,movingDropZone.updateSvgEl(dropzoneNo),movingDropZone.saveCoordsForChoice(dropzoneNo)}),(function(){document.body.removeChild(dragProxy)}))}},DrawlinesQuestion.prototype.handleLineMove=function(e,dropzoneNo){var info=dragDrop.prepare(e);if(!info.start)return;var maxX,maxY,isMoveFromDragsToDropzones,isMoveFromDropzonesToDrags,movingDrag=this,lastX=info.x,lastY=info.y,dragProxy=this.makeDragProxy(info.x,info.y),whichSVG="",bgImage=document.querySelector("img.dropbackground"),svgClass="",selectedElement=this.lineSVGs[dropzoneNo];const dropX=e.clientX,dropY=e.clientY;dragDrop.start(e,$(dragProxy),(function(pageX,pageY){var closeTo=selectedElement.closest("svg");svgClass=closeTo.getAttribute("class"),isMoveFromDragsToDropzones="dragshome"===svgClass,isMoveFromDropzonesToDrags="dropzones"===svgClass&&movingDrag.lines[dropzoneNo].centre1.y>bgImage.height-20,(isMoveFromDragsToDropzones||isMoveFromDropzonesToDrags)&&movingDrag.lines[dropzoneNo].addToDropZone("mouse",selectedElement,dropX,dropY),closeTo=selectedElement.closest("svg");var dimensions=movingDrag.getSvgDimensionsByClass(closeTo,closeTo.getAttribute("class"));maxX=dimensions.maxX,maxY=dimensions.maxY,whichSVG=dimensions.whichSVG,movingDrag.lines[dropzoneNo].moveDrags(parseInt(pageX)-parseInt(lastX),parseInt(pageY)-parseInt(lastY),parseInt(maxX),parseInt(maxY),whichSVG),lastX=pageX,lastY=pageY,movingDrag.updateSvgEl(dropzoneNo),movingDrag.saveCoordsForChoice(dropzoneNo)}),(function(){document.body.removeChild(dragProxy)}))},DrawlinesQuestion.prototype.makeDragProxy=function(x,y){var dragProxy=document.createElement("div");return dragProxy.style.position="absolute",dragProxy.style.top=y+"px",dragProxy.style.left=x+"px",dragProxy.style.width="1px",dragProxy.style.height="1px",document.body.appendChild(dragProxy),dragProxy},DrawlinesQuestion.prototype.saveCoordsForChoice=function(choiceNo){let imageCoords=[];var items=this.getRoot().find("svg g.choice"+choiceNo),gEleClassAttributes="";items.length&&items.each((function(){var drag=$(this);imageCoords=drag.children("polyline").attr("points"),gEleClassAttributes=drag.attr("class")})),""!==gEleClassAttributes&&gEleClassAttributes.includes("placed")?this.getRoot().find("input.choice"+choiceNo).val(imageCoords):""!==gEleClassAttributes&&gEleClassAttributes.includes("inactive")&&this.getRoot().find("input.choice"+choiceNo).val("")},DrawlinesQuestion.prototype.handleKeyPress=function(e,drag,dropzoneNo,activeElement){var dropzoneElement,x=0,y=0,question=questionManager.getQuestionForEvent(e);switch(dropzoneElement=event.target.closest("g"),e.code){case"ArrowLeft":case"KeyA":x=-1;break;case"ArrowRight":case"KeyD":x=1;break;case"ArrowDown":case"KeyS":y=1;break;case"ArrowUp":case"KeyW":y=-1;break;case"Space":case"Escape":break;default:return}e.preventDefault();var maxX,maxY,whichSVG,closeTo=drag.closest("svg"),svgClass=closeTo.getAttribute("class"),bgImage=document.querySelector("img.dropbackground"),isMoveFromDragsToDropzones="dragshome"===svgClass,isMoveFromDropzonesToDrags="dropzones"===svgClass&&question.lines[dropzoneNo].centre1.y>bgImage.height-20;isMoveFromDragsToDropzones?question.lines[dropzoneNo].addToDropZone("keyboard",dropzoneElement,null,null,"DragsSVG"):isMoveFromDropzonesToDrags&&question.lines[dropzoneNo].addToDropZone("keyboard",dropzoneElement,null,null,"DropZonesSVG"),closeTo=drag.closest("svg");var dimensions=question.getSvgDimensionsByClass(closeTo,closeTo.getAttribute("class"));maxX=dimensions.maxX,maxY=dimensions.maxY,whichSVG=dimensions.whichSVG,"line"===activeElement?question.lines[dropzoneNo].moveDrags(x,y,parseInt(maxX),parseInt(maxY),whichSVG):question.lines[dropzoneNo].move(activeElement,x,y,parseInt(maxX),parseInt(maxY)),question.updateSvgEl(dropzoneNo),this.saveCoordsForChoice(dropzoneNo),drag.focus()},DrawlinesQuestion.prototype.getSvgDimensionsByClass=function(dragElement,className){const closeTo=dragElement.closest("svg");return closeTo&&closeTo.classList.contains(className)?{maxX:closeTo.width.baseVal.value,maxY:closeTo.height.baseVal.value,whichSVG:"dragshome"===className?"DragsSVG":"DropZonesSVG"}:null},DrawlinesQuestion.prototype.getInput=function(drag){var choiceNo=this.getChoiceNoFromElement(drag);return this.getRoot().find("input.choices.choice"+choiceNo)},DrawlinesQuestion.prototype.isInfiniteDrag=function(drag){return drag.hasClass("infinite")},DrawlinesQuestion.prototype.waitForAllImagesToBeLoaded=function(){this.allImagesLoaded||(null!==this.imageLoadingTimeoutId&&clearTimeout(this.imageLoadingTimeoutId),this.getNotYetLoadedImages().length>0?this.imageLoadingTimeoutId=setTimeout((function(){this.waitForAllImagesToBeLoaded()}),100):(this.allImagesLoaded=!0,this.drawDropzone()))},DrawlinesQuestion.prototype.getNotYetLoadedImages=function(){return this.getRoot().find(".drawlines img.dropbackground").not((function(i,imgNode){return this.imageIsLoaded(imgNode)}))},DrawlinesQuestion.prototype.imageIsLoaded=function(imgElement){return imgElement.complete&&0!==imgElement.naturalHeight};var questionManager={eventHandlersInitialised:!1,markerEventHandlersInitialised:{},isPrinting:!1,isKeyboardNavigation:!1,questions:{},noOfLines:null,dropZones:[],questionLines:[],init:function(containerId,readOnly,visibleDropZones,questionLines){if(questionManager.questions[containerId]=new DrawlinesQuestion(containerId,readOnly,visibleDropZones,questionLines),questionManager.questions[containerId].updateCoordinates(),!questionManager.markerEventHandlersInitialised.hasOwnProperty(containerId)){questionManager.markerEventHandlersInitialised[containerId]=!0;var questionContainer=document.getElementById(containerId);if(questionContainer.classList.contains("drawlines")&&!questionContainer.classList.contains("qtype_drawlines-readonly")){var dropArea=document.querySelector(".droparea");dropArea.addEventListener("mousedown",questionManager.handleDropZoneEventMove),dropArea.addEventListener("touchstart",questionManager.handleDropZoneEventMove),dropArea.addEventListener("keydown",questionManager.handleKeyPress),dropArea.addEventListener("keypress",questionManager.handleKeyPress);var drags=document.querySelector(".draghomes");drags.addEventListener("mousedown",questionManager.handleDragHomeEventMove),drags.addEventListener("touchstart",questionManager.handleDragHomeEventMove),drags.addEventListener("keydown",questionManager.handleKeyPress),drags.addEventListener("keypress",questionManager.handleKeyPress)}}},handleDropZoneEventMove:function(event){var dropzoneNo,question=questionManager.getQuestionForEvent(event);event.target.closest(".dropzone .startcircle.shape")?(dropzoneNo=event.target.closest("g").dataset.dropzoneNo,question.handleCircleMove(event,"startcircle",dropzoneNo)):event.target.closest(".dropzone .endcircle.shape")?(dropzoneNo=event.target.closest("g").dataset.dropzoneNo,question.handleCircleMove(event,"endcircle",dropzoneNo)):event.target.closest("polyline.shape")&&(dropzoneNo=event.target.closest("g").dataset.dropzoneNo,question.handleLineMove(event,dropzoneNo))},handleDragHomeEventMove:function(event){var dropzoneNo,question=questionManager.getQuestionForEvent(event);event.target.closest(".dropzone polyline.shape")&&(dropzoneNo=event.target.closest("g").dataset.dropzoneNo,question.handleLineMove(event,dropzoneNo),question.saveCoordsForChoice(dropzoneNo))},getSvg:function(){var svg=document.querySelector(".droparea svg");return null===svg?null:svg},getFormValue:function(name,indexes){return this.getEl(name,indexes).value},handleKeyPress:function(e){var dropzoneElement,dropzoneNo,drag,activeElement,question=questionManager.getQuestionForEvent(e);e.target.closest(".dropzone circle.startcircle")?(dropzoneNo=(dropzoneElement=e.target.closest(".dropzone")).dataset.dropzoneNo,drag=e.target.closest(".dropzone circle.startcircle"),activeElement="startcircle"):e.target.closest(".dropzone circle.endcircle")?(drag=e.target.closest(".dropzone circle.endcircle"),dropzoneNo=(dropzoneElement=e.target.closest(".dropzone")).dataset.dropzoneNo,activeElement="endcircle"):e.target.closest(".dropzone polyline.shape")&&(drag=e.target.closest(".dropzone polyline.shape"),dropzoneNo=(dropzoneElement=e.target.closest(".dropzone")).dataset.dropzoneNo,activeElement="line"),question&&dropzoneElement&&question.handleKeyPress(e,drag,dropzoneNo,activeElement)},handleWindowResize:function(isPrinting){for(var containerId in questionManager.questions)questionManager.questions.hasOwnProperty(containerId)&&(questionManager.questions[containerId].isPrinting=isPrinting,questionManager.questions[containerId].handleResize())},getQuestionForEvent:function(e){var containerId=$(e.currentTarget).closest(".que.drawlines").attr("id");return questionManager.questions[containerId]}};return{init:questionManager.init}}));

//# sourceMappingURL=question.min.js.map